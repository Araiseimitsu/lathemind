{% extends "base.html" %}

{% block title %}NCプログラム生成 - {{ app_name }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- 左カラム: 図面アップロード -->
    <div class="glass-panel p-6">
        <h2 class="text-lg font-bold text-white mb-4">図面アップロード</h2>

        <!-- ファイルアップロードエリア -->
        <div id="upload-area"
            class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer bg-white/5">
            <div id="upload-placeholder">
                <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="mt-2 text-sm text-gray-400">クリックして図面を選択</p>
                <p class="text-xs text-gray-500 mt-1">PNG, JPG (最大10MB)</p>
            </div>
            <div id="preview-container" class="hidden">
                <img id="drawing-preview" class="max-h-48 mx-auto rounded" alt="プレビュー">
                <p id="file-name" class="mt-2 text-sm text-gray-400"></p>
            </div>
        </div>

        <input type="file" id="drawing-input" name="drawing" accept="image/*" class="hidden">

        <!-- 解析ボタン -->
        <form id="analyze-form" enctype="multipart/form-data">
            <input type="file" id="analyze-drawing-input" name="drawing" class="hidden">
            <button type="button" id="analyze-btn" class="w-full mt-4 btn-secondary disabled:opacity-50" disabled>
                図面を解析
            </button>
        </form>

        <!-- 解析結果表示エリア -->
        <div id="analysis-result" class="mt-4"></div>
    </div>

    <!-- 中央カラム: 加工条件入力 -->
    <div class="glass-panel p-6">
        <h2 class="text-lg font-bold text-white mb-4">加工条件</h2>

        <form id="generate-form" enctype="multipart/form-data">
            <!-- 隠しファイル入力 -->
            <input type="file" id="generate-drawing-input" name="drawing" class="hidden">

            <!-- 行程情報 -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-300 mb-3">行程情報</h3>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">行程名</label>
                        <input type="text" id="process_name" name="process_name" class="input-field" value="外径加工"
                            required>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">加工タイプ</label>
                        <select id="process_type" name="process_type" class="input-field">
                            <option value="roughing">荒加工 (roughing)</option>
                            <option value="finishing">仕上げ (finishing)</option>
                            <option value="threading">ねじ切り (threading)</option>
                            <option value="drilling">穴あけ (drilling)</option>
                            <option value="grooving">溝入れ (grooving)</option>
                            <option value="facing">端面加工 (facing)</option>
                            <option value="boring">中ぐり (boring)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 加工条件 -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-300 mb-3">切削条件</h3>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">材質</label>
                        <select id="material" name="material" class="input-field">
                            <option value="SUS304">SUS304</option>
                            <option value="SUS316">SUS316</option>
                            <option value="S45C">S45C</option>
                            <option value="S50C">S50C</option>
                            <option value="A5052">A5052</option>
                            <option value="A6061">A6061</option>
                            <option value="C3604">C3604</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">工具番号</label>
                        <input type="text" id="tool_number" name="tool_number" class="input-field" value="T0101">
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">回転数 (rpm)</label>
                        <input type="number" id="spindle_speed" name="spindle_speed" class="input-field" value="1200"
                            min="100" max="10000" required>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">送り (mm/rev)</label>
                        <input type="number" id="feed_rate" name="feed_rate" step="0.01" class="input-field"
                            value="0.15" min="0.01" required>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">切込み (mm)</label>
                        <input type="number" id="depth_of_cut" name="depth_of_cut" step="0.1" class="input-field"
                            value="2.0" min="0.1">
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1">座標系</label>
                        <select id="coordinate_system" name="coordinate_system" class="input-field">
                            <option value="G54">G54</option>
                            <option value="G55">G55</option>
                            <option value="G56">G56</option>
                            <option value="G57">G57</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="flex items-center space-x-2 text-sm">
                        <input type="checkbox" id="coolant" name="coolant" checked
                            class="rounded border-gray-600 bg-white/10 text-blue-500 focus:ring-blue-500">
                        <span class="text-gray-300">クーラント使用</span>
                    </label>
                </div>
            </div>

            <!-- 生成ボタン -->
            <button type="button" id="generate-btn"
                class="w-full btn-primary mt-4 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                NCプログラムを生成
            </button>
        </form>
    </div>

    <!-- 右カラム: 結果表示 -->
    <div class="glass-panel p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-white">生成結果</h2>
            <button id="download-btn" class="hidden text-sm text-blue-600 hover:text-blue-800"
                onclick="downloadNCProgram()">
                ダウンロード
            </button>
        </div>

        <div id="result-panel">
            <div class="text-center py-12 text-gray-400">
                <svg class="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="mt-4">図面をアップロードして<br>プログラムを生成してください</p>
            </div>
        </div>
    </div>

</div>

<!-- ローディングオーバーレイ -->
<div id="loading-overlay"
    class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass-panel p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
        <span class="text-gray-200">処理中...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/upload.js"></script>
<script src="/static/js/nc_viewer.js"></script>
{% endblock %}